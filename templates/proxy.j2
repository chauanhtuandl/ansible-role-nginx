{% block http_upstream %}
{% if item.nginx_upstreams is defined %}
{% for upstream in item.nginx_upstreams %}
    upstream {{ upstream.name }} {
    {% if upstream.strategy is defined %}
    {{ upstream.strategy }};
    {% endif %}
    {% for server in upstream.servers %}
    server {{ server }};
    {% endfor %}
    {% if upstream.keepalive is defined %}
    keepalive {{ upstream.keepalive }};
    {% endif %}
    }
{% endfor %}
{% endif %}
{% endblock %}

{% block server_redirect %}
{% if item.server_name_redirect is defined and item.server_name_redirect%}
server {
    listen       {{ item.listen | default('80') }};
    server_name  {{ item.server_name_redirect }};
    return       301 $scheme://{{ item.server_name.split(' ')[0] }}$request_uri;
}
{% endif %}
{% endblock %}

server {
       listen	   80;
        proxy_redirect           off;
        proxy_set_header         X-Real-IP $remote_addr;
        proxy_set_header         X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header         Host $http_host;

        location / {
            proxy_pass http://backends;
        }
     }





    {% block server %}
    {% block server_basic -%}
	listen       {{ item.listen | default('80') }};
    {% if item.ssl_state  is defined and item.ssl_state %}
    listen       {{ item.listen_ssl | default('443 ssl http2')}};
    {% endif %}

    {% if item.server_name is defined and item.server_name %}
    server_name {{ item.server_name }};
    {% endif %}

    {% if item.root is defined and item.root %}
    root {{ item.root }};
    {% endif %}
    
    index {{ item.index | default('index.html index.htm') }};
    {% endblock %}

    access_log  /var/log/nginx/{{ item.server_name.split(' ')[0] }}.access;
    error_log   /var/log/nginx/{{ item.server_name.split(' ')[0] }}.error error;

    {% block ssl -%}
    {% if item.ssl_state  is defined and item.ssl_state %}
    ssl_protocols {{ item.ssl_protocols }};
    ssl_prefer_server_ciphers {{ item.ssl_prefer_server_ciphers }};
    ssl_ciphers {{ item.ssl_ciphers }};
    ssl_certificate      {{ item.ssl_certificate }};
    ssl_certificate_key  {{ item.ssl_certificate_key }};
    ssl_session_cache {{ item.ssl_session_cache }};
    ssl_session_timeout {{ item.ssl_session_timeout }};
    {% endif %}
    {% endblock %}

    {% if item.hsts is defined and item.hsts %}
    # Enable HSTS
    {{ item.hsts }};
    {% endif %}

    {% if item.locations is defined and item.locations %}
    {%+ for item in item.locations -%}
        location {{ item.location }}
    {%+ endfor %}
    {% endif %}

    {% if item.error_pages is defined and item.error_pages %}
    {%+ for item in item.error_pages -%}
    error_page {{ item.error_page }}
    {%+ endfor %}
    {% endif %}

    {% if item.return is defined and item.return %}
    return {{ item.return }};
    {% endif %}

    {% if item.extra_parameters is defined and item.extra_parameters %}
    {{ item.extra_parameters|indent(4) }}
    {% endif %}
    {% endblock %}
}